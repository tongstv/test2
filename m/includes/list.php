<?php $maxThreadInPage=24;$threadInPage=16;$strLinkPager='actions/thread';$totalPage=0;$thread_list='';$www_title='';$thread_xem_them='';$order_product=' trv_stt, trv_ngaycapnhat DESC ';if($cid>0){$filter_id=$cid;$sid_ten='';if($fid>0){$web_title=$arr_cnt[$fid]['ten'].' - '.$arr_bnt[$sid]['ten'].' - '.$arr_ant[$cid]['ten'];$strFilter.=" AND ant_id = ".$fid;$strLinkPager='actions/thread&fid='.$fid;$filter_id=$fid;}else if($sid>0&&isset($arr_bnt[$sid])){$strFilter.=" AND (ant_id = ".$sid." OR ant_id IN (select ant_id from tbl_a_nhomtin where ant_trangthai > 0 and this_id = ".$sid.") )";$strLinkPager='actions/thread&sid='.$sid;$web_title=$arr_bnt[$sid]['ten'].' - '.$arr_ant[$cid]['ten'];$sid_ten=' &raquo; '.$arr_bnt[$sid]['ten'];$filter_id=$sid;}else{$strFilter.=" AND (ant_id = ".$cid." OR ant_id IN (select ant_id from tbl_a_nhomtin where ant_trangthai > 0 and (this_id = ".$cid." or this_id in (select ant_id from tbl_a_nhomtin where ant_trangthai > 0 and this_id = ".$cid.") ) ) )";$strLinkPager='actions/thread&cid='.$cid;$web_title=$arr_ant[$cid]['ten'];}$www_title='<div><a href="c'.$cid.'/">'.$arr_ant[$cid]['ten'].$sid_ten.'</a></div>';$sql=$func->q("SELECT ant_title, ant_meta_title, ant_keywords, ant_news_keywords, ant_description FROM tbl_a_nhomtin WHERE ant_id = ".$filter_id);if(mysql_num_rows($sql)>0){$row=mysql_fetch_assoc($sql);$web_title=$row['ant_title'];$meta_title=$row['ant_meta_title'];$keywords=$row['ant_keywords'];$news_keywords=$row['ant_news_keywords'];$description=$row['ant_description'];}}else{if($act=='hot'||$act=='view'){$strsql=$func->q("SELECT trv_ngaycapnhat FROM tbl_tinraovat WHERE ".$strFilter." ORDER BY ".$order_product." LIMIT ".($threadInPage*5).", 1");if(mysql_num_rows($strsql)){$rows=mysql_fetch_assoc($strsql);$strFilter.=" AND trv_ngaycapnhat > ".$rows['trv_ngaycapnhat'];}if($act=='view'){$web_title='Sản phẩm HOT';$group_go_to='<span>'.$web_title.'</span>';$order_product=' trv_luotxem DESC ';$strLinkPager='actions/view';}else{$web_title='Sản phẩm bán chạy';$group_go_to='<span>'.$web_title.'</span>';$order_product=' trv_mua DESC ';$strLinkPager='actions/hot';}}else if($act=='history'){$web_title='Sản phẩm đã xem';$group_go_to='<span>'.$web_title.'</span>';$strLinkPager='actions/history';$filterHistory="";$view=array();if(isset($_SESSION['thread_view'])){$view=$_SESSION['thread_view'];}foreach($view as $v){$filterHistory.=",".$v;}if($filterHistory!=''){$strFilter.=" AND trv_id IN (".substr($filterHistory,1).")";}}else if($act=='giovang'){$web_title='Giờ vàng giá SỐC';$group_go_to='<span>'.$web_title.'</span>';$strFilter.=" AND trv_giovang != 0";$strLinkPager='actions/giovang';}else if($act=='search'&&isset($_REQUEST['k'])&&($search_key=trim($_REQUEST['k']))!=''){$search_key=$func->non_mark_seo($search_key);$search_key=str_replace('-',' ',$search_key);$web_title='Tìm kiếm: '.$search_key;$strLinkPager='q.html?act=search&k='.str_replace(' ','+',$search_key);$explode=explode(' ',$search_key);$strSearch="";if(count($explode)==1){$strSearch=" trv_id LIKE '%{$search_key}%' OR trv_tags LIKE '%{$search_key}%' ";}else{if(count($explode)>4){$i=1;$strSearch_='';foreach($explode as $v){$strSearch_.=' '.$v;if($i%3==0){$strSearch_=trim($strSearch_);if($strSearch_!=''){if($strSearch==""){$strSearch.=" trv_tags LIKE '%{$strSearch_}%'";}else{$strSearch.=" OR trv_tags LIKE '%{$strSearch_}%'";}$strSearch_='';}else{$i--;}}$i++;}if($strSearch_!=''&&strlen($strSearch_)>5){$strSearch_=trim($strSearch_);if($strSearch_!=''){$strSearch.=" OR trv_tags LIKE '%{$strSearch_}%' ";}}}else{$strSearch=" trv_tags LIKE '%{$search_key}%' ";}}$strSearch=" AND (".$strSearch.")";$strFilter.=$strSearch;
}else{$web_title=$__cf_row['cf_title'];}$www_title='<div><a href="'.$strLinkPager.'">'.$web_title.'</a></div>';$meta_title=$__cf_row['cf_meta_title'];$keywords=$__cf_row['cf_keywords'];$news_keywords=$__cf_row['cf_news_keywords'];$description=$__cf_row['cf_description'];}$sql=$func->q("SELECT trv_id FROM tbl_tinraovat WHERE ".$strFilter);$totalThread=mysql_num_rows($sql);if($totalThread>0){$totalPage=ceil($totalThread/$threadInPage);if(isset($_GET['p'])){$page=(int)$_GET['p'];}if($page>$totalPage){$page=$totalPage;}$offset=($page-1)*$threadInPage;$sql=$func->q("SELECT ".$strForSelect." FROM tbl_tinraovat WHERE ".$strFilter." ORDER BY ".$order_product." LIMIT ".$offset.", ".$threadInPage);$thread_list.=select_thread_www($sql);if($totalPage>1){if($page<$totalPage){$thread_xem_them='<div class="thread-xem-them"><a href="'.$strLinkPager.'&p='.($page+1).'">Xem thêm</a></div>';}}}else{if($act=='search'&&strlen($search_key)>5){if(isset($_SESSION['cache_search'])&&$search_key==$_SESSION['cache_search']){}else{$func->q("INSERT INTO tbl_search (s_key) VALUES ('".$search_key."')");$_SESSION['cache_search']=$search_key;}}$thread_list.=$strThreadIsNull;}$main_content=$func->str_template('template/list.html',array('tmp.js'=>'var this_page='.$page.',totalPage='.$totalPage.',strLinkPager=\''.$strLinkPager.'\';','tmp.www_title'=>$www_title,'tmp.thread_xem_them'=>$thread_xem_them,'tmp.thread_list'=>$thread_list));