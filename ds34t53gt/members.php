<?php $web_title="Thành viên | ";$strFilter="";$strLinkPager='9999/members';$threadInPage=50;$key='';$thread_list='';$p_page='';$admin_promission=false;if(isset($_GET['update_status'])){$update_status=(int)$_GET['update_status'];if($update_status>0){$_status=0;}else{$_status=1;}$func->q("UPDATE tbl_thanhvien SET tv_trangthai = ".$update_status." WHERE tv_trangthai = ".$_status);}if(isset($_GET['module'])&&($module=$_GET['module'])!=''){$strLinkPager.='&module='.$module;if($module=='search'&&isset($_REQUEST['s_iw'])&&($key=trim($_REQUEST['s_iw']))!=''){$strLinkPager.='&s_iw='.str_replace(' ','+',$key);if(strlen($key)==1){$strFilter=" WHERE tv_email LIKE '{$key}%'";}else{$strFilter=" WHERE tv_id LIKE '%{$key}%' OR tv_email LIKE '%{$key}%' OR tv_dienthoai LIKE '%{$key}%'";}}else if($module=='admin'){$strFilter=" WHERE tv_id IN (select tv_id from tbl_admin)";$admin_promission=true;}else if($module=='money'){$strFilter=" WHERE tv_money > 0";}else if($module=='export'){$strFilter="";if(isset($_GET['invoi2'])){$strFilter=" WHERE tv_count_invoice > 1";$strLinkPager.='&invoi2=true';}$str='';$threadInPage=500;$sql=$func->q("SELECT tv_id FROM tbl_thanhvien".$strFilter);$totalThread=mysql_num_rows($sql);if($totalThread>0){$totalPage=ceil($totalThread/$threadInPage);if($page>$totalPage){$page=$totalPage;}$offset=($page-1)*$threadInPage;$sql=$func->q("SELECT * FROM tbl_thanhvien ".$strFilter." ORDER BY tv_id DESC LIMIT ".$offset.", ".$threadInPage);$i=0;while($row=mysql_fetch_assoc($sql)){$str.=' <tr> <td>'.$row['tv_id'].'</td> <td>'.$row['tv_email'].'</td> <td>'.$row['tv_hoten'].'</td> <td>'.$row['tv_dienthoai'].'</td> <td>'.$row['tv_diachi'].'</td> </tr> ';if($i<250){if($row['tv_count_invoice']==0){$strsql=$func->q("SELECT COUNT(hd_id) as c FROM tbl_in_con_voi WHERE tv_id = ".$row['tv_id']);$rows=mysql_fetch_assoc($strsql);$tv_count_invoice=$rows['c'];if($tv_count_invoice>0){$func->q("UPDATE tbl_thanhvien SET tv_count_invoice = ".$tv_count_invoice." WHERE tv_id = ".$row['tv_id']);$i++;}}}}if($totalPage>1){$p_page=$func->part_page($page,$totalPage,$strLinkPager.'&p=');}}echo $func->str_template($dir_admin.'template/members_export.html',array('tmp.web_link'=>$web_link,'tmp.totalThread'=>number_format($totalThread),'tmp.p_page'=>$p_page,'tmp.str'=>$str));exit();}}$sql=$func->q("SELECT tv_id FROM tbl_thanhvien".$strFilter);$totalThread=mysql_num_rows($sql);if($totalThread>0){$totalPage=ceil($totalThread/$threadInPage);if($page>$totalPage){$page=$totalPage;}$offset=($page-1)*$threadInPage;$sql=$func->q("SELECT tv_id, tv_email, tv_hoten, tv_ngaydangnhap, tv_money FROM tbl_thanhvien ".$strFilter." ORDER BY tv_id DESC LIMIT ".$offset.", ".$threadInPage);if($admin_promission==true){while($row=mysql_fetch_assoc($sql)){$tv_id=$row["tv_id"];$strsql=$func->q("SELECT * FROM tbl_admin WHERE tv_id = ".$row['tv_id']);$rows=mysql_fetch_assoc($strsql);$str_rows='';$i=0;foreach($rows as $v){if($i>0){$str_rows.=$v;}$i++;}$thread_list.=' <tr> <td><a href="9999/members_details&tv_id='.$tv_id.'">'.$tv_id.'</a></td> <td><a href="9999/members_details&tv_id='.$tv_id.'">'.$row['tv_email'].'</a> (<a href="9999/admin_add&id='.$tv_id.'&email='.$row['tv_email'].'">'.$str_rows.'</a>)</td> <td>'.$row["tv_hoten"].'</td> <td>'.number_format($row['tv_money']).'</td> <td>'.date('d/m/y a',$row['tv_ngaydangnhap']).'</td> <tr>';}}else{while($row=mysql_fetch_assoc($sql)){$tv_id=$row["tv_id"];$thread_list.=' <tr> <td><a href="9999/members_details&tv_id='.$tv_id.'">'.$tv_id.'</a></td> <td><a href="9999/members_details&tv_id='.$tv_id.'">'.$row['tv_email'].'</a></td> <td>'.$row["tv_hoten"].'</td> <td>'.number_format($row['tv_money']).'</td> 
<td>'.date('d/m/y a',$row['tv_ngaydangnhap']).'</td> <tr>';}}if($totalPage>1){$p_page=$func->part_page($page,$totalPage,$strLinkPager.'&p=');}}$main_content=$func->str_template($dir_admin.'template/members.html',array('tmp.totalThread'=>$totalThread,'tmp.key'=>$key,'tmp.p_page'=>$p_page,'tmp.thread_list'=>$thread_list));