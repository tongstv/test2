<?php function cereate_filter($o){global $date_server;global $year_curent;global $month_curent;global $day_curent;global $date_time;if($o=='all')return '';switch($o){case "between":if(isset($_GET['d1'])&&($d1=trim($_GET['d1']))!=''&&isset($_GET['d2'])&&($d2=trim($_GET['d2']))!=''){$thang_trc=strtotime($d1);$thang_sau=strtotime($d2)+(24*3600);$return_filter="tbl_in_con_voi.hd_ngaygui > ".$thang_trc." AND tbl_in_con_voi.hd_ngaygui < ".$thang_sau;}break;case "thismonth":$thang_nay=strtotime($year_curent."-".$month_curent."-01");$return_filter="tbl_in_con_voi.hd_ngaygui > ".$thang_nay;break;case "yesterday":$str_date=strtotime($date_server);$return_filter="(tbl_in_con_voi.hd_ngaygui > ".($str_date-(24*3600))." AND tbl_in_con_voi.hd_ngaygui < ".$str_date.")";break;case "lastmonth":$_month_curent=$month_curent-1;$_year_curent=$year_curent;if($_month_curent==0){$_month_curent=12;$_year_curent-=1;}$thang_truoc=strtotime($_year_curent."-".$_month_curent."-01");$thang_nay=strtotime($year_curent."-".$month_curent."-01");$return_filter="(tbl_in_con_voi.hd_ngaygui > ".$thang_truoc." AND tbl_in_con_voi.hd_ngaygui < ".$thang_nay.")";break;case "last7days":$return_filter="tbl_in_con_voi.hd_ngaygui > ".($date_time-(24*3600*7));break;case "last30days":$return_filter="tbl_in_con_voi.hd_ngaygui > ".($date_time-(24*3600*30));break;case "today":$return_filter="tbl_in_con_voi.hd_ngaygui > ".strtotime($date_server);break;default:$return_filter="tbl_in_con_voi.hd_ngaygui > ".($date_time-(24*3600));}return " AND ".$return_filter;}$strLinkPager='9999/log_cart';$for_referene='';if(isset($_GET['invoice_display'])){$strFilter=" tbl_in_con_voi.hd_id > 0 ";$strLinkPager.='&invoice_display=all';}else if(isset($_GET['q'])&&($q=trim($_GET['q']))!=''){$strFilter=" tbl_in_con_voi.ads_referre_domain != '' AND tbl_in_con_voi.ads_referre LIKE '%{$q}%'";$strLinkPager.='&q='.$q;$for_referene.='&q='.$q;}else{$strFilter=" tbl_in_con_voi.ads_referre_domain != ''";}$strFilterById="";$threadInPage=68;$str_page='';$type_display='';$for_site='';$doanh_thu=0;$filter='';if(isset($_GET['d'])&&($filter=trim($_GET['d']))!=''){$type_display=$filter;$strLinkPager.='&d='.$filter;}$strFilter.=cereate_filter($filter);if($filter=='between'&&isset($_GET['d1'])&&($d1=trim($_GET['d1']))!=''&&isset($_GET['d2'])&&($d2=trim($_GET['d2']))!=''){$strLinkPager.='&d1='.$d1.'&d2='.$d2;}if($id>0){$strFilterById=" AND tbl_chitiethoadon.trv_id = ".$id;$strLinkPager.='&id='.$id;}if(isset($_GET['for_site'])&&($for_site=trim($_GET['for_site']))!=''){$strFilter.=" AND tbl_in_con_voi.ads_referre_domain = '".$for_site."'";$strLinkPager.='&for_site='.$for_site;}$totalThread=$func->c("SELECT cthd_id FROM tbl_chitiethoadon WHERE hd_id IN (select hd_id from tbl_in_con_voi where ".$strFilter.")".$strFilterById);if($totalThread>0){$totalPage=ceil($totalThread/$threadInPage);if($page>$totalPage){$page=$totalPage;}$offset=($page-1)*$threadInPage;$sql="SELECT tbl_chitiethoadon.hd_id, tbl_chitiethoadon.trv_id, tbl_chitiethoadon.trv_gia, tbl_in_con_voi.hd_ngaygui, tbl_in_con_voi.ads_referre_domain, tbl_in_con_voi.ads_referre, tbl_in_con_voi.ads_cookie, tbl_tinraovat.trv_tieude, tbl_tinraovat.trv_seo FROM tbl_chitiethoadon, tbl_in_con_voi, tbl_tinraovat WHERE ".$strFilter." AND tbl_chitiethoadon.trv_id = tbl_tinraovat.trv_id AND tbl_chitiethoadon.hd_id = tbl_in_con_voi.hd_id ".$strFilterById." ORDER BY tbl_chitiethoadon.hd_id DESC LIMIT ".$offset.", ".$threadInPage;$sql=$func->q($sql);while($row=mysql_fetch_assoc($sql)){$hd_id=$row['hd_id'];$trv_id=$row['trv_id'];$trv_gia=$row['trv_gia'];$doanh_thu+=$trv_gia;$ads_referre_domain=$row['ads_referre_domain'];
$ads_referre=$row['ads_referre'];$ads_cookie=$row['ads_cookie'];$hd_ngaygui=$row['hd_ngaygui'];$trv_tieude=$row['trv_tieude'];$trv_seo=$row['trv_seo'];$main_content.=' <tr> <td><a href="9999/invoice_details&id='.$hd_id.'" target="_blank">'.$hd_id.'</a></td> <td><a href="9999/log_cart&id='.$trv_id.'" class="small">'.$trv_tieude.'</a> <a href="'.$func->_p_link($trv_id,$trv_seo).'" target="_blank">-&gt;</a></td> <td class="referral-to-external">'.$ads_referre.'</td> <td class="referrence-to-campaign">'.$ads_referre.'</td> <td>'.date('H:i d/m/y',$hd_ngaygui).'</td> <td>'.$ads_cookie.'</td> </tr> ';}if($totalPage>1){$str_page=$func->part_page($page,$totalPage,$strLinkPager.'&p=');}}else{$str_page='<h2 align="center">Không có dữ liệu...</h2>';}$main_content=$func->str_template($dir_admin.'template/log_cart.html',array('tmp.js'=>'var type_display=\''.$type_display.'\',totalThread='.$totalThread.',for_site=\''.$for_site.'\',for_referene=\''.$for_referene.'\',year_curent='.$year_curent.',month_curent='.(int)$month_curent.',day_curent='.(int)$day_curent.',pro_id='.$id.';','tmp.doanh_thu'=>str_replace(',','.',number_format($doanh_thu)),'tmp.totalThread'=>$totalThread,'tmp.str_page'=>$str_page,'tmp.main_content'=>$main_content)); 
