<?php $min_discount=200000;$don_dat_truoc=0;$tbl_chitiethoadon='tbl_chitiethoadon';$sql=$func->q("SELECT * FROM tbl_in_con_voi WHERE hd_id = ".$id);if(mysql_num_rows($sql)>0){$row=mysql_fetch_assoc($sql);}else{$sql=$func->q("SELECT * FROM tbl_in_con_voi_restore WHERE hd_id = ".$id);if(mysql_num_rows($sql)>0){$row=mysql_fetch_assoc($sql);$tbl_chitiethoadon='tbl_chitiethoadon_restore';}else{$row=NULL;}}if($row!=NULL){$hd_ten=$row['hd_ten'];$hd_diachi=$row['hd_diachi'];$hd_ghichu=$row['hd_ghichu'];$hd_ghichu_admin=$row['hd_ghichu_admin'];$hd_dienthoai=$row['hd_dienthoai'];$hd_ngaygui=$row['hd_ngaygui'];$hd_khuyenmai=$row['hd_khuyenmai'];$hd_ngaythanhtoan=$row['hd_ngaythanhtoan'];if($hd_ngaythanhtoan>0){$hd_ngaythanhtoan=date('d-m-Y (H:i)',$hd_ngaythanhtoan);}else{$hd_ngaythanhtoan='<em>Chưa thanh toán</em>';}$hd_giadattruoc=$row['hd_giadattruoc'];$hd_trangthai=$row['hd_trangthai'];$hd_time_update=$row['hd_time_update'];$tv_id=$row['tv_id'];$ads_referre=$row['ads_referre'];$staff_id=$row['staff_id'];$str_hd_trangthai='';foreach($arr_hd_trangthai as $k=>$v){if($k==$hd_trangthai){$str_hd_trangthai.='<option value="'.$k.'" selected="selected">'.$v.'</option>';}else{$str_hd_trangthai.='<option value="'.$k.'">'.$v.'</option>';}}$str_alert_trangthai='';if($hd_trangthai==3){$check_time_update=$date_time-$hd_time_update;if($check_time_update<300){$str_alert_trangthai='<div class="dang-xac-nhan">Hóa đơn đang được kiểm duyệt</div>';}}else{if($hd_trangthai==0){$sql="UPDATE tbl_in_con_voi SET hd_trangthai = 3, hd_admin = ".$mtv_id.", hd_time_update = ".$date_time." WHERE hd_id = ".$id;$func->q($sql);}}$view=array();if(isset($_SESSION['ss_invoice_view'])){$view=$_SESSION['ss_invoice_view'];}if(!isset($view[$id])){$func->log_admin_order('Xem hóa đơn',$id);$view[$id]=$id;$_SESSION['ss_invoice_view']=$view;}$strsql=$func->q("SELECT ".$tbl_chitiethoadon.".*, tbl_tinraovat.trv_tieude, tbl_tinraovat.trv_seo, tbl_tinraovat.trv_img, tbl_tinraovat.trv_giovang, tbl_tinraovat.trv_color FROM ".$tbl_chitiethoadon.", tbl_tinraovat WHERE ".$tbl_chitiethoadon.".hd_id = ".$id." AND ".$tbl_chitiethoadon.".trv_id = tbl_tinraovat.trv_id GROUP BY ".$tbl_chitiethoadon.".trv_id ORDER BY ".$tbl_chitiethoadon.".cthd_id DESC");$product_invoi_list='';$tongtien=0;if(mysql_num_rows($strsql)>0){while($rows=mysql_fetch_assoc($strsql)){$cthd_id=$rows['cthd_id'];$cthd_soluong=$rows['cthd_soluong'];$trv_id=$rows['trv_id'];if($rows['trv_size']!=''){$rows['trv_size']=' ('.$rows['trv_size'].')';}$trv_gia=$rows['trv_gia'];$trv_giadattruoc=$rows['trv_giadattruoc'];$don_dat_truoc+=$trv_giadattruoc*$cthd_soluong;$trv_tieude=$rows['trv_tieude'];$trv_seo=$rows['trv_seo'];$trv_img=$rows['trv_img'];$trv_giovang=$rows['trv_giovang'];$str_giovang='&nbsp;';if($trv_giovang>0){$str_giovang='<a href="export_excel.php?act=invoice_giovang&id='.$trv_id.'" target="_blank">Excel</a>';}if($rows['trv_color']!=''){$rows['trv_color']=' - '.$rows['trv_color'];}$tongtien_line=$trv_gia*$cthd_soluong;$tongtien+=$tongtien_line;$animate_id='update_sl'.$cthd_id;$product_invoi_list.=' <tr> <td>'.$trv_id.'</td> <td><a href="'.$func->_p_link($trv_id,$trv_seo).'" target="_blank">'.$trv_tieude.'</a>'.$rows['trv_color'].$rows['trv_size'].'</td> <td>'.$str_giovang.'</td> <td>'.number_format($trv_gia).'</td> <td><input type="text" value="'.$cthd_soluong.'" name="'.$animate_id.'" id="'.$animate_id.'" data-id="'.$cthd_id.'" class="change-update-cart-quantity" style="width:38px" /></td> <td>'.number_format($tongtien_line).'</td> </tr> ';}}else{$sql="UPDATE tbl_in_con_voi SET hd_trangthai = 4, hd_admin = ".$mtv_id.", 
hd_time_update = ".$date_time." WHERE hd_id = ".$id;$func->q($sql);if($mtv_id>1){header('Location: '.$web_link.'9999/invoice');}}$tv_money=0;if($tongtien>$min_discount){$strsql=$func->q("SELECT tv_money FROM tbl_thanhvien WHERE tv_id = ".$tv_id." LIMIT 0, 1");$rows=mysql_fetch_assoc($strsql);$tv_money=(int)$rows['tv_money'];}$log_admin_oder='';if($arr_session_admin['ad_oder_change']==1){$strsql="SELECT tbl_log_admin.*, tbl_thanhvien.tv_email FROM tbl_log_admin, tbl_thanhvien WHERE tbl_log_admin.hd_id = ".$id." AND tbl_log_admin.ad_id = tbl_thanhvien.tv_id ORDER BY tbl_log_admin.la_id DESC";$strsql=$func->q($strsql);while($rows=mysql_fetch_assoc($strsql)){$log_admin_oder.='<tr><td><a href="9999/members_details&tv_id='.$rows["ad_id"].'">'.$rows['tv_email'].'</a></td><td>'.date('d/m/Y (H:i)',$rows["la_ngay"]).'</td><td>'.$rows['la_ip'].'</td><td>'.$rows['la_noidung'].'</td></tr>';}}if($hd_giadattruoc==0){$hd_giadattruoc=$don_dat_truoc;}$main_content=$func->str_template($dir_admin.'template/invoice_details.html',array('tmp.js_stt'=>'var hd_id='.$id.',hd_trangthai='.$hd_trangthai.',tongtien='.$tongtien.',tv_money='.$tv_money.',min_discount='.$min_discount.',don_dat_truoc='.$hd_giadattruoc.',ad_oder_change='.$arr_session_admin['ad_oder_change'].';','tmp.id'=>$id,'tmp.hd_ten'=>$hd_ten,'tmp.hd_diachi'=>$hd_diachi,'tmp.hd_ghichu'=>$hd_ghichu,'tmp.hd_ghichu_admin'=>$hd_ghichu_admin,'tmp.hd_dienthoai'=>$hd_dienthoai,'tmp.tv_id'=>$tv_id,'tmp.ads_referre'=>$ads_referre,'tmp.str_alert_trangthai'=>$str_alert_trangthai,'tmp.log_admin_oder'=>$log_admin_oder,'tmp.hd_ngaygui'=>date('d-m-Y (H:i)',$hd_ngaygui),'tmp.hd_ngaythanhtoan'=>$hd_ngaythanhtoan,'tmp.hd_trangthai'=>'<select name="t_trangthai">'.$str_hd_trangthai.'</select>','tmp.staff_id'=>$staff_id,'tmp.str_da_dat_truoc'=>$arr_hd_trangthai[8],'tmp.hd_khuyenmai'=>number_format($hd_khuyenmai),'tmp.tongtien'=>number_format($tongtien),'tmp.tongtien_khuyenmai'=>number_format($tongtien-$hd_khuyenmai),'tmp.hd_giadattruoc'=>number_format($hd_giadattruoc),'tmp.product_invoi_list'=>$product_invoi_list));$main_content=$func->arr_tmp($row,$main_content);}else{$part_page='<h2 align="center">Không có dữ liệu...</h2>';}