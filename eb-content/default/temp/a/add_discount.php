<?php $sql=$func->q("SELECT hd_khuyenmai, tv_id FROM tbl_in_con_voi WHERE hd_id = ".$id);if(mysql_num_rows($sql)>0){$row=mysql_fetch_assoc($sql);$hd_khuyenmai=$row['hd_khuyenmai'];$tv_id=$row['tv_id'];if($hd_khuyenmai>0){echo 'Đơn hàng này đã nhận được khuyến mại trước đó <strong>'.number_format($hd_khuyenmai).'</strong>đ';}else{if(isset($_GET['money_add'])&&($tv_money=(int)$_GET['money_add'])>0){}else{$strsql=$func->q("SELECT tv_money FROM tbl_thanhvien WHERE tv_id = ".$tv_id);if(mysql_num_rows($sql)>0){$rows=mysql_fetch_assoc($strsql);$tv_money=$rows['tv_money'];}else{die('Không xác định được thông tin tài khoản');}}$hd_khuyenmai=$tv_money;$strsql="UPDATE tbl_in_con_voi SET hd_khuyenmai = ".$hd_khuyenmai." WHERE hd_id = ".$id;$func->q($strsql);echo 'Chiết khấu cho đơn hàng thành công (<strong>'.number_format($hd_khuyenmai).'</strong>đ)';$tv_money-=$hd_khuyenmai;$strsql="UPDATE tbl_thanhvien SET tv_money = ".$tv_money." WHERE tv_id = ".$tv_id;$func->q($strsql);$func->log_admin('Chiết khấu '.$hd_khuyenmai.' cho hóa đơn #'.$id);}}else{echo 'Không xác định được hóa đơn: #'.$id;} 
